<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script src="https://use.fontawesome.com/d5a524b2fd.js"></script>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAABYlAAAWJQFJUiTwAAAC
qUlEQVRYw+2Xz2sTQRTHvzO7/UH80ViD1KoYFZEehIJgix5aCfRYxUtJBNuL4kFoDmLEU/AieLH+
A9IezK1YSw5aCKgQEQSpeGhrtbiS1lTzo12a3dpNZjy0jU0622Y3P05+j7Mz733evDczbwnnHFb1
4KN6gVIySoAW3WDIMf4CwMDDDueSVVvUhnMXpWSCAC1bhi8DCMKGLAPMp6RAUqV7lIQEJSHhy08Z
s3EZsZR0yxPS2q3aI6WmwBvW/RJBgJCCyJFc4fiTLZj6BkAw4nO8rghA37jukiW8pATnRN8FAJt6
EvE5/GWlYMP5OzPnu2jQE9KGywLYiPw07KvfE9KGbAH4wnrQZuSinei2DEAp7qByCloqQm9Y98sU
j4vH2w5S3O9oEBqKxnKIxnJ4NZc183Ui4nN8L2kHCNBlNcSLRyXc7axHoLPebMoVYZ0JAQiO7ebw
2ZQBRWVQdeD8YQlXz6yb6jkpY3Qmi69pVrzEXTJAKcWnqAxTSYbkCseHhRwA5CFOHaAigPaKXMVm
imeYrXWyXYfH96+zqw6guZGg/2xd/tu3NKs+wLW2OuH4xJww/5UHKNZihiMay2Hks1F+CjhHvPjV
MzsFswmGH8vcNriwCDkwX+opWMzwsnauYqfgP0DFALxh/ToBjogmawYwnWKYTjFohmVfbk9I83tC
mlP4GvaOas37Gsl7qw3IDi2ZmZYBuCM+x1LBDhDgZpndT6lqAuDfngJCemuY+m5RDbytIcDYNgDO
+SMOZGrg/BOAYWFL1jeuuySK2wCcZqv1VaOPcZ6/pn+pDKvGug2JEqVpb8NOrfhkxOcYs/VntKmu
p7+fS/Rfe7WQzkJfy9sYUQKtA1W9iLI5fm+HVA1V/SaM3jg0s5blPRyIb32bAFxSAq2TVu39BS8W
CJFblaXvAAAAAElFTkSuQmCC"/>
    <title>Penn Course Alert</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css">
    <!--<script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>-->
    <script type="text/javascript" src="/uri.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-21029575-12"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-21029575-12');
    </script>
    <style>
      body {
        background-color: #fafcff;
        position: relative;
        padding-bottom:190px;
      }
      .input {
        border-style: hidden;
        border-radius: 0px;
        box-shadow: 0px 0px 8px 3px #F1F3F6;
      }  
      .field {
        padding-bottom: 0.5rem;
      }
      .footer {
        background-color: #ffffff;
        box-shadow: 0px 0px 8px 1px #F1F3F6;
        position: absolute;
        width: 100%;
        bottom: 0px;
      }

      .title, .subtitle, p, label {
        color: #4a4a4a;
      }
      .field {
        padding-bottom:0.7rem;
      }
    </style>
  </head>
  <body>
    <section class="section">
      <div class="container has-text-centered">
        <div class="level" style="margin-bottom:0.5rem">
          <div class="level-item">
            <figure class="image is-64x64" style="padding-right:1rem">
            <img src="./src/js/PCA_logo.svg">
            </figure>
            <h1 class="title">
              Penn Course Alert
            </h1>
          </div>
        </div>
        <p class="subtitle is-size-5">
        Get notified when a course opens up, by text and email
        </p>
      </div>
      
        <!-- Resubscribe and unsubscribe modal -->
        <div class="modal" id="modal" tabindex="-1" role="dialog">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Penn Course Alert</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <p>Would you like to keep receiving notifications?</p>
              </div>
              <button type="button" class="button is-info" onClick='resubmit()'>Resubscribe</button>
              <button type="button" id="unsubscribe" class="button is-info" onClick='resubscribe()'>Unsubscribe</button>
              <script>
                function resubmit() {
                  $('#submit_form').submit();
                }
                function resubscribe() {
                  const info = parseURL(window.location.href);
                  window.location.href = "/unsubscribe?email="+info.email+"&course="+info.course;
                }
              </script>
              <!--<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>-->

            </div>
          </div>
        </div>

      <div class="container has-text-centered is-block-mobile" style="margin-top:3.5rem; width: 360px">
        <form id="submit_form" class="lmk-text-align-center" action="/submitted" method="POST">
          <div class="field" id="bloodhound">
            <div class="control">
              <input class="input is-medium typeahead" type="text" placeholder="Course" id="course" name="course" required>
            </div>
          </div>
          <div class="field">
            <div class="control">
              <input class="input is-medium" type="text" placeholder="Email" id="email" name="email" required>
            </div>
          </div>
          <div class="field">
            <div class="control">
              <!--<br />Optional: Text Message Notifications<br />-->
              <input class="input is-medium" type="tel" placeholder="Phone number (for text alerts)" id="phone" name="phone">
              <!--Carrier<br /> action="/submitted" method="POST">-->
            </div>
          </div>
          <div class="field is-grouped level">
            <div class="control">
              <div class="select">
                <select id="carrier" name="carrier">
                  <option selected disabled="disabled" value="nocarrier">Choose your carrier</option>
                  <option value="Verizon">Verizon</option>
                  <option value="ATT">AT&amp;T</option>
                  <option value="TMobile">T-Mobile</option>
                  <option value="Sprint">Sprint</option>
                  <option value="USCellular">US Cellular</option>
                </select><br>
              </div>
            </div>
            <div class="control has-text-right">
              <label class="checkbox">
                <input type="checkbox" placeholder="notifications" id="notifications" name="notifications"><label for="notifications"> Keep me notified</label>
              </label>
            </div>
          </div>
          <div class="control has-text-centered">
            <a class="button is-info" type="submit">Submit</a>
          </div>
        </form>
      </div>
    </section>
    </body>

    <footer class="footer">
      <div class="container">
        <div class="content has-text-centered">
          <p style="font-size:0.8rem">
          Made with <span class="icon is-small" style="color:#F56F71"><i class="fa fa-heart"></i></span> by <a href="http://pennlabs.org" target="_blank">Penn Labs</a>
      </div>
    </footer>

    <script type="text/javascript" src="/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="/typeahead.bundle.js"></script>
    <script type="text/javascript" src="/searchbar.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>


    <script>

      // on submission of form, update local storage to remember user's data
      $('form').submit(e => {
        localStorage.setItem('lmkEmail', e.target.email.value);
        localStorage.setItem('lmkPhone', e.target.phone.value);
        localStorage.setItem('lmkCarrier', e.target.carrier.value);
        localStorage.setItem('lmkNotifications', e.target.notifications.checked);
      });

      // parses form info out of link
      function parseURL(url) {
        let formInfo = {};
        const linkData = url.replace(/.*\?/, '').split('&');
        for (let i = 0; i < linkData.length; i++) {
            let split = linkData[i].split('=');
            formInfo[split[0]] = split[1];
        }
        return formInfo;
      }

      // first, pre-populate form from local storage
      $('#email').val(localStorage.getItem('lmkEmail'));
      $('#phone').val(localStorage.getItem('lmkPhone'));
      if (localStorage.getItem('lmkCarrier')) {
        $('#carrier').val(localStorage.getItem('lmkCarrier'));
      }

      if (localStorage.getItem('lmkNotifications') === 'true') {
        $('#notifications').prop('checked', true);
      }

      // if URL contains '?', then only pre-populate form from parsed URL element
      // if it exists (in order to not overwrite local storage populated fields
      // with undefined)
      if (window.location.href.includes('?')) {
        const info = parseURL(window.location.href)
        if ('email' in info) {
          $('#email').val(info.email);
        }
        if ('course' in info) {
          $('#course').val(info.course)
        }
        if ('phone' in info) {
          $('#phone').val(info.phone);
        }
        if ('carrier' in info) {
          $('#carrier').val(info.carrier);
        }
        if ('notifications' in info) {
          $('#notifications').prop('checked', true);
        }
        if ('error' in info) {
        	if (info.error === 'courseIsOpen') {
                $('#description').append("<div class='error-msg'>Error: Course already open</div>");
            }
            else if (info.error === 'backend') {
              $('#description').append("<div class='error-msg'>Error: The Penn registrar has returned an error. Please try again later. We're sorry for the inconvenience!</div>");
            }
        }
        if ('success' in info) {
          $('#description').append("<div class='success-msg'>Registration Successful. Thank you for using Penn Course Alert!</div>");
        }
        if ('unsub' in info) {
          $('#description').append('<div class="success-msg">Unsubscribe Successful. Thank you for using Penn Course Alert!</div>')
        }
        if ('action' in info) {
          if (info.action === 'resubscribe') {
            $('#modal').modal('show')
          }
        }
      }
    </script>
  </body>
</html>
